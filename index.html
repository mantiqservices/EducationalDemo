<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MANTIQ | Academy Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Export Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const externalConfig = {
            apiKey: "AIzaSyACmad2fQGzF_L1B7WXRYQGqbRx_hKQ2ns",
            authDomain: "mantiqedu.firebaseapp.com",
            projectId: "mantiqedu",
            storageBucket: "mantiqedu.firebasestorage.app",
            messagingSenderId: "226946538055",
            appId: "1:226946538055:web:f31e5a7f80662366e02f62",
            measurementId: "G-BFGV0W27QJ"
        };

        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) 
            ? JSON.parse(__firebase_config) 
            : externalConfig;
            
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mantiq-edu-prod';

        window.mantiqDb = db;
        window.mantiqAuth = auth;
        window.mantiqAppId = appId;
        window.mantiqFirestore = { doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Noto+Sans+Arabic:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --mantiq-cyan: #38bdf8;
            --mantiq-navy: #001e3c;
        }

        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans Arabic', sans-serif;
            transition: background-color 0.3s ease;
            user-select: none;
        }

        [dir="rtl"] {
            font-family: 'Noto Sans Arabic', 'Plus Jakarta Sans', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-overlay {
            background-color: rgba(0, 30, 60, 0.7);
            backdrop-filter: blur(8px);
        }

        /* Subtle Dark Mode Shadow Replacement */
        .dark .dark-shadow-only {
            border: none !important;
            box-shadow: 0 4px 20px -2px rgba(255, 255, 255, 0.03), 0 2px 10px -2px rgba(255, 255, 255, 0.02);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        mantiq: {
                            cyan: '#38bdf8',
                            navy: '#001e3c',
                            navyLight: '#002b55'
                        }
                    }
                }
            }
        };
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen overflow-x-hidden" dir="ltr">

    <div id="app" class="min-h-screen"></div>
    <div id="notification-container" class="fixed bottom-10 right-10 z-[110] space-y-3"></div>

    <script type="module">
        import { signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { collection, onSnapshot, doc, setDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Constants & UI ---
        const UI = {
            en: {
                dashboard: "Academy Overview", volume: "Total Revenue", assets: "Students",
                addRecord: "Add Entry", cancel: "Cancel", role: "Super Administrator",
                submit: "Save & Sync", studentProfile: "Student Summary", backToList: "Back to List",
                netCash: "Net Cash Flow", inflow: "Total Inflow", outflow: "Total Outflow",
                restricted: "Action Restricted.", searchPlaceholder: "Search records...",
                filterAll: "All Grades", addTeacher: "Add Teacher", addCategory: "Add Category",
                addSub: "Add Sub", addGrade: "Add Grade", gradeName: "Grade Name",
                gradeFee: "Base Fee", todaySchedule: "Today's Schedule",
                noLectures: "No lectures scheduled for today.", empty: "No records found.", action: "Action",
                online: "Connected", offline: "Offline", exportExcel: "Excel", exportPDF: "PDF",
                rightClickAlert: "Security Alert: Right-click is restricted on this platform."
            },
            ar: {
                dashboard: "نظرة عامة", volume: "إجمالي الإيرادات", assets: "عدد الطلاب",
                addRecord: "إضافة سجل", cancel: "إلغاء", role: "مدير النظام",
                submit: "حفظ ومزامنة", studentProfile: "ملخص الطالب", backToList: "العودة للقائمة",
                netCash: "صافي الربح", inflow: "إجمالي الوارد", outflow: "إجمالي الصادر",
                restricted: "إجراء مقيد.", searchPlaceholder: "بحث في السجلات...",
                filterAll: "كل المستويات", addTeacher: "إضافة معلم", addCategory: "إضافة تصنيف",
                addSub: "إضافة فرعي", addGrade: "إضافة مستوى", gradeName: "اسم المستوى",
                gradeFee: "الرسوم الأساسية", todaySchedule: "محاضرات اليوم",
                noLectures: "لا توجد محاضرات مجدولة لليوم.", empty: "لا توجد سجلات حالية.", action: "إجراء",
                online: "متصل", offline: "غير متصل", exportExcel: "اكسل", exportPDF: "PDF",
                rightClickAlert: "تنبيه أمني: النقر بزر الفأرة الأيمن غير مسموح به في هذه المنصة."
            }
        };

        const ACADEMY_NAV = [
            { id: 'dashboard', label: { en: 'Dashboard', ar: 'لوحة القيادة' }, icon: 'layout-dashboard' },
            { id: 'students', label: { en: 'Students', ar: 'الطلاب' }, icon: 'users', tableCols: { en: ['Stu-ID', 'Student Name', 'Age', 'Phone', 'Grade'], ar: ['رقم الطالب', 'اسم الطالب', 'العمر', 'الهاتف', 'السنة الدراسية'] } },
            { id: 'subjects', label: { en: 'Subjects', ar: 'المواد والجدول' }, icon: 'calendar-clock', tableCols: { en: ['Grade', 'Subject Name', 'Teacher Name', 'Day', 'Room', 'Start Time'], ar: ['المستوى', 'اسم المادة', 'المعلم', 'اليوم', 'القاعة', 'وقت البدء'] } },
            { id: 'income', label: { en: 'Income', ar: 'الإيرادات' }, icon: 'trending-up', tableCols: { en: ['Stu-ID', 'Student Name', 'Category', 'Subcategory', 'Amount', 'Date'], ar: ['رقم الطالب', 'اسم الطالب', 'الفئة', 'الفئة الفرعية', 'المبلغ', 'التاريخ'] } },
            { id: 'expenses', label: { en: 'Expenses', ar: 'المصاريف' }, icon: 'trending-down', tableCols: { en: ['Expense ID', 'Title', 'Category', 'Subcategory', 'Amount', 'Date'], ar: ['المعرف', 'العنوان', 'الفئة', 'الفئة الفرعية', 'المبلغ', 'التاريخ'] } },
            { id: 'cash_flow', label: { en: 'Cash Flow', ar: 'التدفق المالي' }, icon: 'arrow-left-right', tableCols: { en: ['Type', 'Label', 'Category', 'Amount', 'Date'], ar: ['النوع', 'البيان', 'الفئة', 'المبلغ', 'التاريخ'] } },
            { id: 'config', label: { en: 'Settings', ar: 'الإعدادات' }, icon: 'settings-2', tableCols: { en: ['Entity', 'Detail', 'Value'], ar: ['الكيان', 'التفاصيل', 'القيمة'] } }
        ];

        // --- State Management ---
        let state = {
            page: 'dashboard',
            darkMode: false,
            language: 'en',
            isModalOpen: false,
            isSidebarOpen: false,
            loading: false,
            viewingStudentId: null,
            searchQuery: '',
            gradeFilter: 'All',
            user: null,
            isConnected: false,
            data: {
                students: [],
                income: [],
                expenses: [],
                subjects: [],
                attendance: [],
                config: {
                    teachers: ['Mr. Ahmed Khalil', 'Ms. Sara Smith'],
                    gradeFees: {
                        'Kindergarten': 2500, '1st Grade': 3500, '2nd Grade': 3500,
                        '3rd Grade': 4000, '4th Grade': 4500, '5th Grade': 5000, '6th Grade': 5500
                    },
                    incomeCategories: [
                        { name: 'Tuition', subs: ['Base Fee', 'Late Fee'] },
                        { name: 'Academics', subs: ['Books', 'Exams'] }
                    ],
                    expenseCategories: [
                        { name: 'Operations', subs: ['Rent', 'Utility'] },
                        { name: 'HR', subs: ['Salary'] }
                    ]
                }
            }
        };

        const _t = (en, ar) => state.language === 'en' ? en : ar;
        const ut = (key) => UI[state.language][key];

        // --- Right-Click Restriction logic ---
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            pushNotify(ut('rightClickAlert'));
        });

        // --- Firebase Integration Logic ---
        
        window.initAuth = async () => {
            const auth = window.mantiqAuth;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
            }

            onAuthStateChanged(auth, (user) => {
                state.user = user;
                state.isConnected = !!user;
                if (user) setupListeners();
                render();
            });
        };

        function setupListeners() {
            const db = window.mantiqDb;
            const appId = window.mantiqAppId;

            const syncCollection = (collName) => {
                const q = collection(db, 'artifacts', appId, 'public', 'data', collName);
                onSnapshot(q, (snapshot) => {
                    state.data[collName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                }, (err) => {
                    if (err.code === 'permission-denied') pushNotify("Firestore Permission Denied.");
                });
            };

            ['students', 'income', 'expenses', 'subjects'].forEach(syncCollection);

            const configDoc = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
            onSnapshot(configDoc, (docSnap) => {
                if (docSnap.exists()) state.data.config = docSnap.data();
                else setDoc(configDoc, state.data.config);
                render();
            });
        }

        async function updateFirebaseConfig() {
            if (!state.user) return;
            const db = window.mantiqDb;
            const appId = window.mantiqAppId;
            const configDoc = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
            await setDoc(configDoc, state.data.config);
        }

        // --- Export Logic ---
        window.exportToExcel = (data, fileName) => {
            if (!data || data.length === 0) return pushNotify("No data to export");
            const cleanData = data.map(item => { const { id, ...rest } = item; return rest; });
            const ws = XLSX.utils.json_to_sheet(cleanData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, `${fileName}.xlsx`);
        };

        window.exportToPDF = (data, fileName, columns) => {
            if (!data || data.length === 0) return pushNotify("No data to export");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.setFontSize(18); doc.text(fileName, 14, 22);
            const tableRows = data.map(item => columns.map(col => item[col] || '-'));
            doc.autoTable({ head: [columns], body: tableRows, startY: 30, theme: 'striped', headStyles: { fillColor: [0, 30, 60] } });
            doc.save(`${fileName}.pdf`);
        };

        // --- Business Logic ---
        
        // Revised generateID to follow a sequence based on current data
        function generateID(prefix = 'STU-', currentList = []) { 
            let max = 0;
            const idKey = prefix === 'STU-' ? 'Stu-ID' : 'Expense ID';
            
            currentList.forEach(item => {
                const idStr = item[idKey] || '';
                const numPart = parseInt(idStr.replace(prefix, ''));
                if (!isNaN(numPart) && numPart > max) {
                    max = numPart;
                }
            });
            
            const nextID = max + 1;
            // Pad to 4 digits for consistent look: STU-0001
            return prefix + String(nextID).padStart(4, '0');
        }

        function getTotals() {
            const inc = state.data.income.reduce((s, i) => s + (parseFloat(i.Amount) || 0), 0);
            const exp = state.data.expenses.reduce((s, e) => s + (parseFloat(e.Amount) || 0), 0);
            return { inc, exp, net: inc - exp };
        }

        window.handleCategoryChange = (selectEl) => {
            const type = state.page === 'income' ? 'income' : 'expense';
            const list = type === 'income' ? state.data.config.incomeCategories : state.data.config.expenseCategories;
            const subSelect = selectEl.form.Subcategory;
            subSelect.innerHTML = '<option value="">Select Subcategory</option>';
            const category = list.find(c => c.name === selectEl.value);
            if (category && category.subs) {
                category.subs.forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = sub;
                    subSelect.appendChild(opt);
                });
            }
        };

        window.addTeacher = async () => {
            const input = document.getElementById('config-teacher-input');
            const name = input.value.trim();
            if (name) { state.data.config.teachers.push(name); input.value = ''; await updateFirebaseConfig(); pushNotify("Teacher added."); }
        };

        window.deleteTeacher = async (index) => {
            state.data.config.teachers.splice(index, 1); await updateFirebaseConfig(); pushNotify("Teacher removed.");
        };

        window.addGrade = async () => {
            const nameInput = document.getElementById('config-grade-name-input');
            const feeInput = document.getElementById('config-grade-fee-input');
            const name = nameInput.value.trim(); const fee = parseFloat(feeInput.value);
            if (name && !isNaN(fee)) { state.data.config.gradeFees[name] = fee; nameInput.value = ''; feeInput.value = ''; await updateFirebaseConfig(); pushNotify("Grade added."); }
        };

        window.deleteGrade = async (grade) => { delete state.data.config.gradeFees[grade]; await updateFirebaseConfig(); pushNotify("Grade removed."); };

        window.addCategory = async (type) => {
            const input = document.getElementById(`config-${type}-cat-input`);
            const name = input.value.trim();
            if (name) {
                const list = type === 'income' ? state.data.config.incomeCategories : state.data.config.expenseCategories;
                list.push({ name, subs: [] });
                input.value = '';
                await updateFirebaseConfig();
                pushNotify("Category added.");
            }
        };

        window.deleteCategory = async (type, index) => {
            const list = type === 'income' ? state.data.config.incomeCategories : state.data.config.expenseCategories;
            list.splice(index, 1); await updateFirebaseConfig(); pushNotify("Category removed.");
        };

        window.addSub = async (type, catIdx) => {
            const input = document.getElementById(`config-${type}-sub-input-${catIdx}`);
            const name = input.value.trim();
            if (name) {
                const list = type === 'income' ? state.data.config.incomeCategories : state.data.config.expenseCategories;
                list[catIdx].subs.push(name);
                input.value = '';
                await updateFirebaseConfig();
                pushNotify("Subcategory added.");
            }
        };

        window.deleteSub = async (type, catIdx, subIdx) => {
            const list = type === 'income' ? state.data.config.incomeCategories : state.data.config.expenseCategories;
            list[catIdx].subs.splice(subIdx, 1); await updateFirebaseConfig(); pushNotify("Subcategory removed.");
        };

        window.setPage = (p) => { state.page = p; state.viewingStudentId = null; state.searchQuery = ''; state.gradeFilter = 'All'; state.isSidebarOpen = false; render(); };

        function pushNotify(msg) {
            const container = document.getElementById('notification-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = 'bg-mantiq-navy dark:bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 fade-in border-l-4 border-mantiq-cyan transition-all';
            toast.innerHTML = `<i data-lucide="info" class="text-mantiq-cyan w-5 h-5"></i><span class="text-xs font-bold">${msg}</span>`;
            container.appendChild(toast); lucide.createIcons();
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 4000);
        }
        window.pushNotify = pushNotify;

        // --- Rendering ---
        function renderStudentSummary(id) {
            const student = state.data.students.find(s => s['Stu-ID'] === id);
            if (!student) return `<p>Not Found</p>`;
            const income = state.data.income.filter(i => i['Stu-ID'] === id);
            const totalPaid = income.reduce((acc, curr) => acc + parseFloat(curr.Amount), 0);

            return `
                <div class="fade-in space-y-8">
                    <div class="flex items-center justify-between">
                        <button onclick="window.setViewingStudent(null)" class="flex items-center gap-2 text-slate-400 font-bold text-[10px] uppercase hover:text-mantiq-cyan transition-colors">
                            <i data-lucide="arrow-left" size="16" class="${state.language === 'ar' ? 'rotate-180' : ''}"></i> ${ut('backToList')}
                        </button>
                        <h2 class="text-2xl lg:text-3xl font-black text-mantiq-navy dark:text-white uppercase tracking-tighter">${ut('studentProfile')}</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="bg-white dark:bg-slate-900 p-6 lg:p-10 rounded-[2rem] border border-slate-200 dark:border-none shadow-sm dark:shadow-[0_8px_30px_rgb(0,0,0,0.4)] flex flex-col items-center">
                            <div class="w-20 h-20 rounded-[1.5rem] bg-mantiq-navy text-white flex items-center justify-center font-black text-2xl mb-6 shadow-xl">${student['Student Name'].charAt(0)}</div>
                            <h3 class="text-lg lg:text-xl font-black text-mantiq-navy dark:text-white mb-1 uppercase text-center">${student['Student Name']}</h3>
                            <p class="text-[10px] font-black text-mantiq-cyan tracking-widest mb-10">${student['Stu-ID']}</p>
                            <div class="w-full space-y-4 pt-8 border-t border-slate-100 dark:border-slate-800">
                                ${Object.entries(student).filter(([k]) => k !== 'id').map(([k,v]) => `<div class="flex justify-between items-center"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${k}</span><span class="text-xs font-bold text-slate-700 dark:text-slate-200 text-right ml-2">${v}</span></div>`).join('')}
                            </div>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-emerald-50 dark:bg-emerald-950/20 p-6 lg:p-8 rounded-[1.5rem] border border-emerald-100 dark:border-none shadow-sm dark:shadow-[0_8px_30px_rgb(0,0,0,0.3)]">
                                <h4 class="text-emerald-600 text-[10px] font-black uppercase mb-2 tracking-widest">Financial Standing</h4>
                                <p class="text-3xl lg:text-4xl font-black text-emerald-700 dark:text-emerald-300 tracking-tighter">${totalPaid.toLocaleString()} EGP</p>
                            </div>
                            <div class="bg-white dark:bg-slate-900 rounded-[1.5rem] border border-slate-200 dark:border-none p-6 lg:p-8 shadow-sm dark:shadow-[0_8px_30px_rgb(0,0,0,0.3)]">
                                <h4 class="text-sm font-black text-mantiq-navy dark:text-white uppercase mb-6 flex items-center gap-2"><i data-lucide="receipt" size="18"></i> History</h4>
                                <div class="space-y-4">
                                    ${income.length ? income.map(item => `<div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl"><div><p class="text-xs font-bold">${item.Category} - ${item.Subcategory}</p><p class="text-[10px] text-slate-400 font-bold">${item.Date}</p></div><span class="text-sm font-black text-emerald-600 ml-2">+${parseFloat(item.Amount).toLocaleString()}</span></div>`).join('') : '<p class="text-center text-xs text-slate-400 py-10 italic">No payments recorded</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.setViewingStudent = (id) => { state.viewingStudentId = id; render(); };
        window.closeModal = () => { state.isModalOpen = false; render(); };
        window.openModal = () => { state.isModalOpen = true; render(); };
        window.toggleSidebar = () => { state.isSidebarOpen = !state.isSidebarOpen; render(); };
        window.toggleDarkMode = () => { state.darkMode = !state.darkMode; document.documentElement.classList.toggle('dark'); render(); };
        window.toggleLanguage = () => { state.language = state.language === 'en' ? 'ar' : 'en'; document.body.dir = state.language === 'ar' ? 'rtl' : 'ltr'; render(); };

        function renderDashboard() {
            const stats = getTotals();
            const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const todayLectures = state.data.subjects.filter(s => s.Day === todayName);
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-900 p-6 lg:p-8 rounded-[1.5rem] border border-slate-200 dark:border-none shadow-sm dark:shadow-xl"><h3 class="text-slate-400 text-[10px] font-black uppercase mb-2">Total Students</h3><p class="text-2xl font-black">${state.data.students.length}</p></div>
                    <div class="bg-white dark:bg-slate-900 p-6 lg:p-8 rounded-[1.5rem] border border-slate-200 dark:border-none shadow-sm dark:shadow-xl"><h3 class="text-slate-400 text-[10px] font-black uppercase mb-2">Revenue</h3><p class="text-2xl font-black text-emerald-500">${stats.inc.toLocaleString()}</p></div>
                    <div class="bg-white dark:bg-slate-900 p-6 lg:p-8 rounded-[1.5rem] border border-slate-200 dark:border-none shadow-sm dark:shadow-xl"><h3 class="text-slate-400 text-[10px] font-black uppercase mb-2">Expenses</h3><p class="text-2xl font-black text-rose-500">${stats.exp.toLocaleString()}</p></div>
                    <div class="bg-white dark:bg-slate-900 p-6 lg:p-8 rounded-[1.5rem] border border-slate-200 dark:border-none shadow-sm dark:shadow-xl"><h3 class="text-slate-400 text-[10px] font-black uppercase mb-2">Net Cash</h3><p class="text-2xl font-black text-mantiq-cyan">${stats.net.toLocaleString()}</p></div>
                </div>
                <div class="mb-12">
                    <h3 class="text-xl font-black uppercase mb-6 flex items-center gap-2"><i data-lucide="calendar" class="text-mantiq-cyan"></i> ${ut('todaySchedule')}</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${todayLectures.length ? todayLectures.map(lec => `<div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-none shadow-sm dark:shadow-xl">
                            <div class="flex justify-between items-start mb-4"><div class="p-2 bg-mantiq-cyan/10 text-mantiq-cyan rounded-xl"><i data-lucide="book-open" size="20"></i></div><span class="text-[9px] font-black uppercase text-slate-400">${lec.Room}</span></div>
                            <h4 class="text-lg font-black">${lec['Subject Name']}</h4><p class="text-xs font-bold text-slate-500">${lec['Teacher Name']}</p>
                            <div class="flex items-center justify-between border-t border-slate-50 dark:border-slate-800 mt-4 pt-4"><div class="flex items-center gap-2 text-mantiq-cyan"><i data-lucide="clock" size="14"></i><span class="text-xs font-black">${lec['Start Time']}</span></div><span class="text-[9px] px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-lg font-black uppercase">${lec.Grade}</span></div>
                        </div>`).join('') : `<div class="col-span-full py-12 text-center bg-slate-100 dark:bg-slate-900/40 rounded-[1.5rem] border-2 border-dashed border-slate-200 dark:border-slate-800"><p class="text-slate-400 font-bold uppercase p-4">${ut('noLectures')}</p></div>`}
                    </div>
                </div>
            `;
        }

        function renderCashFlow() {
            const totals = getTotals();
            let all = [...state.data.income.map(x => ({ ...x, type: 'in', label: x['Student Name'] })), ...state.data.expenses.map(x => ({ ...x, type: 'out', label: x['Title'] }))].sort((a,b) => new Date(b.Date) - new Date(a.Date));
            if (state.searchQuery) { const q = state.searchQuery.toLowerCase(); all = all.filter(item => item.label.toLowerCase().includes(q) || (item.Category && item.Category.toLowerCase().includes(q))); }
            return `
                <div class="fade-in space-y-8">
                    <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-6">
                        <h2 class="text-2xl lg:text-3xl font-black text-mantiq-navy dark:text-white uppercase tracking-tighter">${ut('netCash')}</h2>
                        <div class="flex gap-2">
                             <button onclick='window.exportToExcel(${JSON.stringify(all)}, "CashFlow")' class="bg-emerald-100 text-emerald-700 px-4 py-3 rounded-xl font-black text-[10px] uppercase flex items-center gap-2 hover:bg-emerald-200"><i data-lucide="file-spreadsheet" size="16"></i> ${ut('exportExcel')}</button>
                             <button onclick='window.exportToPDF(${JSON.stringify(all)}, "CashFlow", ["type", "label", "Category", "Amount", "Date"])' class="bg-rose-100 text-rose-700 px-4 py-3 rounded-xl font-black text-[10px] uppercase flex items-center gap-2 hover:bg-rose-200"><i data-lucide="file-text" size="16"></i> ${ut('exportPDF')}</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6">
                        <div class="bg-emerald-50 dark:bg-emerald-950/20 p-6 rounded-[1.5rem] border border-emerald-100 dark:border-none shadow-sm dark:shadow-xl"><h4 class="text-emerald-600 text-[10px] font-black uppercase mb-1">${ut('inflow')}</h4><p class="text-2xl font-black text-emerald-700">${totals.inc.toLocaleString()} EGP</p></div>
                        <div class="bg-rose-50 dark:bg-rose-950/20 p-6 rounded-[1.5rem] border border-rose-100 dark:border-none shadow-sm dark:shadow-xl"><h4 class="text-rose-600 text-[10px] font-black uppercase mb-1">${ut('outflow')}</h4><p class="text-2xl font-black text-rose-700">${totals.exp.toLocaleString()} EGP</p></div>
                        <div class="bg-mantiq-navy dark:bg-slate-800 p-6 rounded-[1.5rem] shadow-xl"><h4 class="text-mantiq-cyan text-[10px] font-black uppercase mb-1">${ut('netCash')}</h4><p class="text-2xl font-black text-white">${totals.net.toLocaleString()} EGP</p></div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-[1.5rem] border border-slate-200 dark:border-none p-4 lg:p-6 shadow-sm dark:shadow-2xl overflow-hidden">
                        <div class="mb-6"><div class="relative"><i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i><input type="text" placeholder="${ut('searchPlaceholder')}" value="${state.searchQuery}" oninput="window.handleSearch(this.value)" class="w-full bg-slate-50 dark:bg-slate-800 pl-12 pr-4 py-3 rounded-xl text-sm outline-none border-none" /></div></div>
                        <div class="overflow-x-auto custom-scrollbar">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 dark:bg-slate-800/50 text-[10px] uppercase font-black text-slate-400"><tr><th class="px-6 py-6">Status</th><th class="px-6 py-6">Label</th><th class="px-6 py-6">Category</th><th class="px-6 py-6">Amount</th><th class="px-6 py-6">Date</th></tr></thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                                    ${all.map(t => `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/20 transition-colors"><td class="px-6 py-6"><span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase ${t.type==='in'?'bg-emerald-100 text-emerald-600':'bg-rose-100 text-rose-600'}">${t.type==='in'?'Inflow':'Outflow'}</span></td><td class="px-6 py-6 text-sm font-bold">${t.label}</td><td class="px-6 py-6 text-xs text-slate-500">${t.Category || '-'}</td><td class="px-6 py-6 font-black text-sm ${t.type==='in'?'text-emerald-600':'text-rose-600'}">${t.type==='in'?'+':'-'}${parseFloat(t.Amount).toLocaleString()}</td><td class="px-6 py-6 text-xs text-slate-400">${t.Date}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderConfig() {
            return `
                <div class="fade-in space-y-8 pb-20">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-[1.5rem] border border-slate-200 dark:border-none shadow-sm dark:shadow-xl">
                            <h3 class="text-lg font-black uppercase mb-6 flex items-center gap-2"><i data-lucide="user-plus" class="text-mantiq-cyan"></i> Teachers</h3>
                            <div class="flex gap-2 mb-6">
                                <input id="config-teacher-input" type="text" placeholder="${ut('addTeacher')}..." class="flex-1 bg-slate-50 dark:bg-slate-800 rounded-xl px-4 py-3 text-sm font-bold outline-none" />
                                <button onclick="window.addTeacher()" class="bg-mantiq-navy dark:bg-slate-700 text-white p-3 rounded-xl"><i data-lucide="plus"></i></button>
                            </div>
                            <div class="space-y-3">${state.data.config.teachers.map((t, idx) => `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 dark:bg-slate-800/40 dark:border-none"><span class="text-sm font-bold">${t}</span><button onclick="window.deleteTeacher(${idx})" class="text-rose-400"><i data-lucide="trash-2" size="16"></i></button></div>`).join('')}</div>
                        </div>
                        <div class="bg-white dark:bg-slate-900 p-6 rounded-[1.5rem] border border-slate-200 dark:border-none shadow-sm dark:shadow-xl">
                            <h3 class="text-lg font-black uppercase mb-6 flex items-center gap-2"><i data-lucide="graduation-cap" class="text-mantiq-cyan"></i> Grades & Fees</h3>
                            <div class="space-y-3 mb-6">
                                <input id="config-grade-name-input" type="text" placeholder="${ut('gradeName')}..." class="w-full bg-slate-50 dark:bg-slate-800 rounded-xl px-4 py-3 text-sm font-bold outline-none mb-2" />
                                <div class="flex gap-2">
                                    <input id="config-grade-fee-input" type="number" placeholder="${ut('gradeFee')}..." class="flex-1 bg-slate-50 dark:bg-slate-800 rounded-xl px-4 py-3 text-sm font-bold outline-none" />
                                    <button onclick="window.addGrade()" class="bg-mantiq-navy dark:bg-slate-700 text-white px-6 rounded-xl font-black text-xs uppercase">${ut('addGrade')}</button>
                                </div>
                            </div>
                            <div class="space-y-3">${Object.entries(state.data.config.gradeFees).map(([grade, fee]) => `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 dark:bg-slate-800/40 dark:border-none"><div><p class="text-sm font-black">${grade}</p><p class="text-[10px] text-mantiq-cyan font-bold uppercase">${fee.toLocaleString()} EGP</p></div><button onclick="window.deleteGrade('${grade}')" class="text-rose-400"><i data-lucide="trash-2" size="16"></i></button></div>`).join('')}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.handleSearch = (val) => { state.searchQuery = val; render(); };
        window.handleGradeFilter = (val) => { state.gradeFilter = val; render(); };

        function renderTable() {
            const nav = ACADEMY_NAV.find(n => n.id === state.page);
            let rawData = state.data[state.page] || [];
            if (state.searchQuery) { const q = state.searchQuery.toLowerCase(); rawData = rawData.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(q))); }
            if (state.gradeFilter !== 'All' && ['students', 'subjects', 'income'].includes(state.page)) { rawData = rawData.filter(row => row.Grade === state.gradeFilter); }
            
            return `
                <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-6 mb-10">
                    <div><h2 class="text-2xl font-black uppercase tracking-tighter">${_t(nav.label.en, nav.label.ar)}</h2><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">${rawData.length} Results</p></div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick='window.exportToExcel(${JSON.stringify(rawData)}, "${nav.id}")' class="bg-emerald-100 text-emerald-700 px-4 py-3 rounded-xl font-black text-[10px] uppercase flex items-center gap-2"><i data-lucide="file-spreadsheet" size="16"></i> Excel</button>
                        <button onclick='window.exportToPDF(${JSON.stringify(rawData)}, "${nav.id}", ${JSON.stringify(nav.tableCols.en)})' class="bg-rose-100 text-rose-700 px-4 py-3 rounded-xl font-black text-[10px] uppercase flex items-center gap-2"><i data-lucide="file-text" size="16"></i> PDF</button>
                        <button onclick="window.openModal()" class="bg-mantiq-navy dark:bg-slate-700 text-white px-6 py-4 rounded-xl font-black text-[10px] uppercase shadow-xl hover:scale-105 transition-transform flex-1 lg:flex-none">${ut('addRecord')}</button>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 rounded-[1.5rem] border border-slate-200 dark:border-none shadow-sm dark:shadow-xl mb-8 flex flex-col sm:flex-row gap-4 items-center">
                    <div class="w-full flex-1 relative"><i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i><input type="text" placeholder="${ut('searchPlaceholder')}" value="${state.searchQuery}" oninput="window.handleSearch(this.value)" class="w-full bg-slate-50 dark:bg-slate-800 pl-12 pr-4 py-3 rounded-xl text-sm outline-none border-none" /></div>
                    ${['students', 'subjects', 'income'].includes(state.page) ? `<div class="w-full sm:w-auto flex items-center gap-3 bg-slate-50 dark:bg-slate-800 px-4 py-3 rounded-xl"><span class="text-[10px] font-black uppercase text-slate-400">Filter</span><select onchange="window.handleGradeFilter(this.value)" class="bg-transparent border-none text-xs font-bold outline-none"><option value="All">${ut('filterAll')}</option>${Object.keys(state.data.config.gradeFees).map(g => `<option value="${g}" ${state.gradeFilter === g ? 'selected' : ''}>${g}</option>`).join('')}</select></div>` : ''}
                </div>
                <div class="bg-white dark:bg-slate-900 rounded-[1.5rem] border border-slate-200 dark:border-none overflow-hidden shadow-sm dark:shadow-2xl">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 dark:bg-slate-800/50 text-[10px] uppercase tracking-widest font-black text-slate-400"><tr>${nav.tableCols.en.map((c, i) => `<th class="px-6 py-6 whitespace-nowrap">${_t(c, nav.tableCols.ar[i])}</th>`).join('')}<th class="px-6 py-6 text-center whitespace-nowrap">${ut('action')}</th></tr></thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                                ${rawData.length ? rawData.map(row => `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/20 transition-colors">${nav.tableCols.en.map(k => `<td class="px-6 py-5 font-bold text-sm text-slate-700 dark:text-slate-300 whitespace-nowrap">${row[k] || '-'}</td>`).join('')}<td class="px-6 py-5 text-center flex justify-center gap-2">${state.page === 'students' ? `<button onclick="window.setViewingStudent('${row['Stu-ID']}')" class="p-2 text-mantiq-cyan hover:bg-mantiq-cyan/10 rounded-xl transition-all"><i data-lucide="user" size="18"></i></button>` : ''}<button onclick="window.deleteEntry('${row.id}')" class="p-2 text-slate-300 hover:text-rose-500 transition-all"><i data-lucide="trash-2" size="18"></i></button></td></tr>`).join('') : `<tr><td colspan="10" class="p-20 text-center italic text-slate-400 font-bold uppercase">${ut('empty')}</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.deleteEntry = async (id) => {
            if (!state.user) return;
            const db = window.mantiqDb; const appId = window.mantiqAppId;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', state.page, id)); pushNotify("Entry deleted."); } catch (err) { console.error(err); }
        };

        function renderApp() {
            const navItems = ACADEMY_NAV.map(item => `<button onclick="window.setPage('${item.id}')" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl lg:rounded-2xl text-sm font-bold transition-all ${state.page === item.id ? 'bg-mantiq-cyan text-white shadow-lg' : 'text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 dark:text-slate-400'}"><i data-lucide="${item.icon}" size="18"></i><span class="truncate">${_t(item.label.en, item.label.ar)}</span></button>`).join('');
            const currentNav = ACADEMY_NAV.find(n => n.id === state.page);

            return `
                <div class="flex h-screen overflow-hidden">
                    <div id="mobile-sidebar-overlay" onclick="window.toggleSidebar()" class="fixed inset-0 z-40 sidebar-overlay transition-opacity lg:hidden ${state.isSidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}"></div>
                    <aside class="fixed lg:static w-72 flex flex-col h-full bg-white dark:bg-slate-900 border-slate-200 dark:border-none dark:shadow-[0_0_40px_rgba(0,0,0,0.5)] z-50 transition-transform duration-300 lg:translate-x-0 ${state.language === 'en' ? 'left-0 border-r -translate-x-full' : 'right-0 border-l translate-x-full'} ${state.isSidebarOpen ? 'translate-x-0' : ''}">
                        <div class="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center"><div class="flex items-center gap-2"><div class="p-1.5 bg-mantiq-cyan rounded-xl"><i data-lucide="graduation-cap" class="text-white w-5 h-5"></i></div><span class="text-xl font-black text-mantiq-navy dark:text-white uppercase">MANTIQ</span></div><button onclick="window.toggleSidebar()" class="lg:hidden"><i data-lucide="x" size="24"></i></button></div>
                        <nav class="flex-1 p-6 space-y-1 overflow-y-auto custom-scrollbar">${navItems}</nav>
                    </aside>
                    <div class="flex-1 h-screen overflow-y-auto custom-scrollbar relative">
                        <header class="h-20 lg:h-24 bg-white/80 dark:bg-slate-950/80 backdrop-blur-xl border-b border-slate-200 dark:border-none dark:shadow-lg sticky top-0 z-20 flex items-center justify-between px-6 lg:px-10">
                            <div class="flex items-center gap-4"><button onclick="window.toggleSidebar()" class="lg:hidden"><i data-lucide="menu" size="24"></i></button><h2 class="text-lg lg:text-2xl font-black text-mantiq-navy dark:text-white uppercase truncate">${state.viewingStudentId ? ut('studentProfile') : _t(currentNav.label.en, currentNav.label.ar)}</h2></div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full"><div class="w-2 h-2 rounded-full ${state.isConnected ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]' : 'bg-rose-500'} animate-pulse"></div><span class="text-[8px] font-black uppercase text-slate-500">${state.isConnected ? ut('online') : ut('offline')}</span></div>
                                <button onclick="window.toggleLanguage()" class="text-[8px] lg:text-[10px] font-black uppercase px-3 lg:px-4 py-2 border rounded-xl border-slate-200 dark:border-slate-800">${state.language === 'en' ? 'Arabic' : 'English'}</button>
                                <button onclick="window.toggleDarkMode()" class="p-2.5 bg-white border border-slate-200 rounded-full dark:bg-slate-800 dark:border-none shadow-sm dark:shadow-md"><i data-lucide="${state.darkMode ? 'sun' : 'moon'}" size="16"></i></button>
                            </div>
                        </header>
                        <main class="p-4 lg:p-12 max-w-7xl mx-auto">${state.viewingStudentId ? renderStudentSummary(state.viewingStudentId) : (state.page === 'dashboard' ? renderDashboard() : (state.page === 'config' ? renderConfig() : (state.page === 'cash_flow' ? renderCashFlow() : renderTable())))}</main>
                    </div>
                </div>
                ${state.isModalOpen ? renderModal() : ''}
            `;
        }

        function renderModal() {
            const nav = ACADEMY_NAV.find(n => n.id === state.page);
            const fields = nav.tableCols.en.map((col, i) => {
                if ((col === 'Stu-ID' && state.page === 'students') || (col === 'Expense ID' && state.page === 'expenses')) return '';
                const label = _t(col, nav.tableCols.ar[i]);

                if (col === 'Teacher Name') return `<div class="flex flex-col gap-1"><label class="text-[9px] font-black uppercase text-slate-400">${label}</label><select name="${col}" class="bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm font-bold">${state.data.config.teachers.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>`;
                if (col === 'Day') return `<div class="flex flex-col gap-1"><label class="text-[9px] font-black uppercase text-slate-400">${label}</label><select name="${col}" class="bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm font-bold">${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(d => `<option value="${d}">${d}</option>`).join('')}</select></div>`;
                if (col === 'Grade') return `<div class="flex flex-col gap-1"><label class="text-[9px] font-black uppercase text-slate-400">${label}</label><select name="${col}" class="bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm font-bold">${Object.keys(state.data.config.gradeFees).map(g => `<option value="${g}">${g}</option>`).join('')}</select></div>`;
                if (col === 'Category') return `<div class="flex flex-col gap-1"><label class="text-[9px] font-black uppercase text-slate-400">${label}</label><select name="${col}" class="bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm font-bold" onchange="window.handleCategoryChange(this)"><option value="">Select Category</option>${(state.page === 'income' ? state.data.config.incomeCategories : state.data.config.expenseCategories).map(c => `<option value="${c.name}">${c.name}</option>`).join('')}</select></div>`;
                if (col === 'Subcategory') return `<div class="flex flex-col gap-1"><label class="text-[9px] font-black uppercase text-slate-400">${label}</label><select name="${col}" class="bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm font-bold"><option value="">Select Category First</option></select></div>`;
                
                // Smart Student Selection for Income
                if (state.page === 'income' && col === 'Student Name') {
                    return `<div class="flex flex-col gap-1"><label class="text-[9px] font-black uppercase text-slate-400">${label}</label><select name="${col}" class="bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm font-bold" required><option value="">Select Student</option>${state.data.students.map(s => `<option value="${s['Student Name']}">${s['Student Name']} (${s['Stu-ID']})</option>`).join('')}</select></div>`;
                }

                return `<div class="flex flex-col gap-1"><label class="text-[9px] font-black uppercase text-slate-400">${label}</label><input type="${col.includes('Date') ? 'date' : (col.includes('Amount') ? 'number' : 'text')}" name="${col}" class="bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-sm font-bold" required /></div>`;
            }).join('');

            return `
                <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay fade-in">
                    <div class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-[2rem] p-6 lg:p-12 shadow-2xl overflow-y-auto max-h-[90vh] custom-scrollbar dark:shadow-[0_20px_60px_rgba(0,0,0,0.6)]">
                        <div class="flex justify-between items-start mb-10"><h2 class="text-xl lg:text-2xl font-black uppercase tracking-tighter">${ut('addRecord')}</h2><button onclick="window.closeModal()" class="text-slate-300 hover:text-rose-500"><i data-lucide="x" size="24"></i></button></div>
                        <form id="add-record-form" onsubmit="window.handleAddData(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${fields}
                            <div class="md:col-span-2 flex flex-col sm:flex-row gap-3 mt-8">
                                <button type="button" onclick="window.closeModal()" class="order-2 sm:order-1 flex-1 bg-slate-100 dark:bg-slate-800 text-slate-500 py-4 rounded-xl font-black text-xs uppercase">${ut('cancel')}</button>
                                <button type="submit" class="order-1 sm:order-2 flex-1 bg-mantiq-navy dark:bg-slate-700 text-white py-4 rounded-xl font-black text-xs uppercase shadow-xl hover:scale-[1.02] transition-transform">${ut('submit')}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        window.handleAddData = async (e) => {
            e.preventDefault(); if (!state.user) return;
            const db = window.mantiqDb; const appId = window.mantiqAppId;
            const form = document.getElementById('add-record-form');
            const formData = new FormData(form);
            const record = {}; formData.forEach((v, k) => record[k] = v);
            
            if (state.page === 'income' && record['Student Name']) {
                const s = state.data.students.find(s => s['Student Name'] === record['Student Name']);
                if (s) { record['Stu-ID'] = s['Stu-ID']; record['Grade'] = s['Grade']; }
            }
            
            // Sequential ID generation for Students and Expenses
            if (state.page === 'students' && !record['Stu-ID']) {
                record['Stu-ID'] = generateID('STU-', state.data.students);
            }
            if (state.page === 'expenses' && !record['Expense ID']) {
                record['Expense ID'] = generateID('EXP-', state.data.expenses);
            }

            state.loading = true; render();
            try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', state.page), record); pushNotify("Success!"); state.isModalOpen = false; } catch (err) { pushNotify("Error: " + err.message); }
            state.loading = false; render();
        };

        function render() { const root = document.getElementById('app'); if (root) { root.innerHTML = renderApp(); lucide.createIcons(); } }

        window.initMockData = () => {
            if (state.data.students.length > 0) return;
            const sNames = ["Ahmed Mohamed", "Sara Khalid"];
            sNames.forEach((n, i) => {
                const id = 'STU-' + String(i + 1).padStart(4, '0');
                state.data.students.push({ 'Stu-ID': id, 'Student Name': n, 'Age': 6 + i, 'Phone': "0102345678" + i, 'Grade': '1st Grade' });
            });
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            state.data.subjects.push({ 'Grade': '1st Grade', 'Subject Name': 'Mathematics', 'Teacher Name': 'Mr. Ahmed Khalil', 'Day': today, 'Room': 'Room 101', 'Start Time': '08:00 AM' });
        };

        window.initMockData(); window.initAuth(); render();
    </script>
</body>
</html>
