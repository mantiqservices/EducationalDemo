<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MANTIQ | Academy Management System</title>
    
    <!-- Scripts Loading -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Export Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Noto+Sans+Arabic:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', 'Noto Sans Arabic', sans-serif; user-select: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-bg { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyACmad2fQGzF_L1B7WXRYQGqbRx_hKQ2ns",
            authDomain: "mantiqedu.firebaseapp.com",
            projectId: "mantiqedu",
            storageBucket: "mantiqedu.firebasestorage.app",
            messagingSenderId: "226946538055",
            appId: "1:226946538055:web:f31e5a7f80662366e02f62"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "mantiq-edu-prod";

        window.fb = { auth, db, appId, collection, doc, setDoc, getDoc, onSnapshot, addDoc, deleteDoc, query, signInAnonymously, onAuthStateChanged };
    </script>

    <!-- React Application -->
    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useMemo, useRef } = React;

        /**
         * Robust Icon Component for Lucide in Browser
         */
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons();
                }
            }, [name]);

            return (
                <span ref={iconRef} className={`inline-flex items-center justify-center ${className}`}>
                    <i data-lucide={name} style={{ width: size, height: size }}></i>
                </span>
            );
        };

        const UI_STRINGS = {
            en: {
                dashboard: "Overview", assets: "Students", inflow: "Inflow", outflow: "Outflow", 
                netCash: "Net", currency: "EGP", addRecord: "Add", cancel: "Cancel", 
                submit: "Save", back: "Back", search: "Search...",
                security: "Security Alert!", online: "Online", offline: "Offline"
            },
            ar: {
                dashboard: "نظرة عامة", assets: "الطلاب", inflow: "الوارد", outflow: "الصادر", 
                netCash: "الصافي", currency: "ج.م", addRecord: "إضافة", cancel: "إلغاء", 
                submit: "حفظ", back: "رجوع", search: "بحث...",
                security: "تنبيه أمني!", online: "متصل", offline: "غير متصل"
            }
        };

        const NAV_ITEMS = [
            { id: 'dashboard', label: { en: 'Dashboard', ar: 'الرئيسية' }, icon: 'layout-dashboard' },
            { id: 'students', label: { en: 'Students', ar: 'الطلاب' }, icon: 'users', cols: ['Stu-ID', 'Student Name', 'Grade', 'Phone'] },
            { id: 'subjects', label: { en: 'Subjects', ar: 'المواد' }, icon: 'calendar-clock', cols: ['Grade', 'Subject Name', 'Teacher Name', 'Day', 'Room'] },
            { id: 'income', label: { en: 'Income', ar: 'الإيرادات' }, icon: 'trending-up', cols: ['Student Name', 'Amount', 'Category', 'Date'] },
            { id: 'expenses', label: { en: 'Expenses', ar: 'المصاريف' }, icon: 'trending-down', cols: ['Title', 'Amount', 'Category', 'Date'] },
            { id: 'config', label: { en: 'Settings', ar: 'الإعدادات' }, icon: 'settings-2' }
        ];

        function App() {
            const [fbReady, setFbReady] = useState(false);
            const [user, setUser] = useState(null);
            const [page, setPage] = useState('dashboard');
            const [lang, setLang] = useState('ar');
            const [searchQuery, setSearchQuery] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [data, setData] = useState({ students: [], income: [], expenses: [], subjects: [], config: { teachers: [] } });
            const [notifications, setNotifications] = useState([]);

            // 1. Wait for Firebase
            useEffect(() => {
                const checkInterval = setInterval(() => {
                    if (window.fb) {
                        setFbReady(true);
                        clearInterval(checkInterval);
                        window.fb.onAuthStateChanged(window.fb.auth, (u) => {
                            if (!u) window.fb.signInAnonymously(window.fb.auth);
                            setUser(u);
                        });
                    }
                }, 100);
                return () => clearInterval(checkInterval);
            }, []);

            // 2. Real-time Listeners
            useEffect(() => {
                if (!fbReady || !user) return;
                
                const collections = ['students', 'income', 'expenses', 'subjects'];
                const unsubs = collections.map(coll => 
                    window.fb.onSnapshot(window.fb.collection(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', coll), (snap) => {
                        setData(prev => ({ ...prev, [coll]: snap.docs.map(d => ({ id: d.id, ...d.data() })) }));
                    })
                );

                const configSub = window.fb.onSnapshot(window.fb.doc(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', 'settings', 'config'), (ds) => {
                    if (ds.exists()) setData(prev => ({ ...prev, config: ds.data() }));
                });

                return () => { unsubs.forEach(u => u()); configSub(); };
            }, [fbReady, user]);

            const pushNotify = (msg) => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, msg }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 3000);
            };

            const handleAdd = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const item = {};
                fd.forEach((v, k) => item[k] = v);
                if (page === 'students') item['Stu-ID'] = "STU-" + Math.floor(Math.random() * 9000 + 1000);

                try {
                    await window.fb.addDoc(window.fb.collection(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', page), item);
                    setIsModalOpen(false);
                    pushNotify("Saved successfully");
                } catch (err) { pushNotify(err.message); }
            };

            const handleDelete = async (id) => {
                try {
                    await window.fb.deleteDoc(window.fb.doc(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', page, id));
                    pushNotify("Deleted");
                } catch (err) { pushNotify(err.message); }
            };

            const filteredData = useMemo(() => {
                const raw = data[page] || [];
                if (!searchQuery) return raw;
                return raw.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(searchQuery.toLowerCase())));
            }, [page, data, searchQuery]);

            if (!fbReady) return <div className="h-screen flex items-center justify-center font-bold text-sky-500">Initializing System...</div>;

            return (
                <div className={`min-h-screen flex bg-slate-50`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    {/* Sidebar */}
                    <aside className="w-72 bg-white border-r p-6 flex flex-col hidden lg:flex">
                        <div className="flex items-center gap-3 mb-10">
                            <div className="p-2 bg-sky-500 rounded-xl shadow-lg shadow-sky-500/20"><Icon name="graduation-cap" className="text-white" /></div>
                            <span className="text-xl font-black tracking-tighter">MANTIQ</span>
                        </div>
                        <nav className="flex-1 space-y-1">
                            {NAV_ITEMS.map(item => (
                                <button key={item.id} onClick={() => setPage(item.id)} className={`w-full flex items-center gap-4 px-5 py-4 rounded-2xl font-bold transition-all ${page === item.id ? 'bg-sky-500 text-white shadow-xl shadow-sky-500/30' : 'text-slate-400 hover:bg-slate-50'}`}>
                                    <Icon name={item.icon} size={20} />
                                    <span>{lang === 'ar' ? item.label.ar : item.label.en}</span>
                                </button>
                            ))}
                        </nav>
                    </aside>

                    {/* Content Area */}
                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-20 bg-white border-b px-8 flex items-center justify-between sticky top-0 z-40">
                            <h2 className="text-xl font-black uppercase">{lang === 'ar' ? NAV_ITEMS.find(n => n.id === page).label.ar : NAV_ITEMS.find(n => n.id === page).label.en}</h2>
                            <div className="flex items-center gap-4">
                                <button onClick={() => setLang(lang === 'en' ? 'ar' : 'en')} className="text-[10px] font-black uppercase px-4 py-2 border rounded-xl">{lang === 'en' ? 'Arabic' : 'English'}</button>
                                <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                            </div>
                        </header>

                        <main className="p-8 max-w-7xl mx-auto w-full fade-in">
                            {page === 'dashboard' ? (
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                    <StatCard label={UI_STRINGS[lang].assets} value={data.students.length} />
                                    <StatCard label={UI_STRINGS[lang].inflow} value={data.income.reduce((a,b)=>a+(parseFloat(b.Amount)||0),0)} color="text-emerald-500" />
                                    <StatCard label={UI_STRINGS[lang].outflow} value={data.expenses.reduce((a,b)=>a+(parseFloat(b.Amount)||0),0)} color="text-rose-500" />
                                    <StatCard label={UI_STRINGS[lang].netCash} value={data.income.reduce((a,b)=>a+(parseFloat(b.Amount)||0),0) - data.expenses.reduce((a,b)=>a+(parseFloat(b.Amount)||0),0)} color="text-sky-500" />
                                </div>
                            ) : page === 'config' ? (
                                <div className="bg-white p-10 rounded-[2.5rem] shadow-sm">
                                    <h3 className="font-bold mb-6">Settings</h3>
                                    <div className="flex gap-2 mb-4">
                                        <input id="t-add" className="bg-slate-50 p-3 rounded-xl flex-1 outline-none" placeholder="Teacher Name..." />
                                        <button onClick={() => {
                                            const v = document.getElementById('t-add').value;
                                            if(v) window.fb.setDoc(window.fb.doc(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', 'settings', 'config'), { teachers: [...(data.config.teachers || []), v] });
                                            document.getElementById('t-add').value = '';
                                        }} className="bg-sky-500 text-white p-3 rounded-xl"><Icon name="plus" /></button>
                                    </div>
                                    <div className="space-y-2">
                                        {(data.config.teachers || []).map((t, i) => (
                                            <div key={i} className="flex justify-between p-4 bg-slate-50 rounded-xl">
                                                <span>{t}</span>
                                                <button onClick={() => window.fb.setDoc(window.fb.doc(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', 'settings', 'config'), { teachers: data.config.teachers.filter((_, idx) => idx !== i) })}><Icon name="trash-2" size={16} className="text-rose-400" /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center gap-4">
                                        <div className="relative flex-1 max-w-md">
                                            <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                                            <input type="text" placeholder={UI_STRINGS[lang].search} value={searchQuery} onChange={(e)=>setSearchQuery(e.target.value)} className="w-full bg-white pl-12 pr-4 py-3 rounded-2xl outline-none shadow-sm" />
                                        </div>
                                        <button onClick={() => setIsModalOpen(true)} className="bg-sky-500 text-white px-8 py-3 rounded-2xl font-black text-xs uppercase shadow-xl shadow-sky-500/20">{UI_STRINGS[lang].addRecord}</button>
                                    </div>
                                    
                                    <div className="bg-white rounded-[2rem] shadow-sm overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left">
                                                <thead className="bg-slate-50 text-[10px] font-black uppercase text-slate-400">
                                                    <tr>
                                                        {NAV_ITEMS.find(n => n.id === page).cols?.map(c => <th key={c} className="px-6 py-5">{c}</th>)}
                                                        <th className="px-6 py-5 text-center">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {filteredData.map((row, idx) => (
                                                        <tr key={idx} className="hover:bg-slate-50">
                                                            {NAV_ITEMS.find(n => n.id === page).cols?.map(c => <td key={c} className="px-6 py-4 text-sm font-bold">{row[c] || '-'}</td>)}
                                                            <td className="px-6 py-4 text-center">
                                                                <button onClick={() => handleDelete(row.id)} className="text-slate-300 hover:text-rose-500"><Icon name="trash-2" size={16} /></button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>

                    {/* Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] modal-bg flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-lg p-10 rounded-[2.5rem] shadow-2xl">
                                <h2 className="text-2xl font-black mb-8">{UI_STRINGS[lang].addRecord}</h2>
                                <form onSubmit={handleAdd} className="space-y-4">
                                    {NAV_ITEMS.find(n => n.id === page).cols?.filter(c => !c.includes('ID')).map(c => (
                                        <div key={c}>
                                            <label className="text-[10px] font-black uppercase text-slate-400 mb-1 block">{c}</label>
                                            {c === 'Teacher Name' ? (
                                                <select name={c} className="w-full bg-slate-50 p-3 rounded-xl outline-none font-bold">
                                                    {data.config.teachers?.map(t => <option key={t} value={t}>{t}</option>)}
                                                </select>
                                            ) : (
                                                <input name={c} type={c === 'Amount' ? 'number' : (c === 'Date' ? 'date' : 'text')} className="w-full bg-slate-50 p-3 rounded-xl outline-none font-bold" required />
                                            )}
                                        </div>
                                    ))}
                                    <div className="flex gap-3 pt-6">
                                        <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 bg-slate-100 py-4 rounded-2xl font-black text-xs uppercase">{UI_STRINGS[lang].cancel}</button>
                                        <button type="submit" className="flex-1 bg-sky-500 text-white py-4 rounded-2xl font-black text-xs uppercase">{UI_STRINGS[lang].submit}</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Notifications */}
                    <div className="fixed bottom-6 right-6 z-[110] space-y-2 pointer-events-none">
                        {notifications.map(n => (
                            <div key={n.id} className="bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-xl flex items-center gap-3 animate-bounce">
                                <Icon name="bell" size={16} className="text-sky-400" />
                                <span className="text-xs font-bold">{n.msg}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const StatCard = ({ label, value, color = "text-slate-900" }) => (
            <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-50">
                <h4 className="text-slate-400 text-[10px] font-black uppercase mb-2">{label}</h4>
                <p className={`text-3xl font-black ${color}`}>{value}</p>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
